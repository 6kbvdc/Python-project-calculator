import math
import re

print("FX-82 Complete Scientific Calculator")
print("Type 'exit' to quit")
print("Supported: + - * / % ** sqrt() sin() cos() tan() asin() acos() atan() log() ln() factorial() pi e")

angle_mode = "deg"  # Default angle mode

functions = {
    'sqrt': math.sqrt,
    'factorial': math.factorial,
    'sin': lambda x: math.sin(math.radians(x)) if angle_mode=="deg" else math.sin(x),
    'cos': lambda x: math.cos(math.radians(x)) if angle_mode=="deg" else math.cos(x),
    'tan': lambda x: math.tan(math.radians(x)) if angle_mode=="deg" else math.tan(x),
    'asin': lambda x: math.degrees(math.asin(x)) if angle_mode=="deg" else math.asin(x),
    'acos': lambda x: math.degrees(math.acos(x)) if angle_mode=="deg" else math.acos(x),
    'atan': lambda x: math.degrees(math.atan(x)) if angle_mode=="deg" else math.atan(x),
    'log': math.log10,
    'ln': math.log
}

constants = {
    'pi': math.pi,
    'e': math.e
}

func_pattern = re.compile(r'([a-z]+)\(([^()]*)\)')

def evaluate(expr):
    # Replace constants
    for const, val in constants.items():
        expr = expr.replace(const, str(val))

    # Recursively solve functions
    while True:
        match = func_pattern.search(expr)
        if not match:
            break
        func, arg = match.groups()
        if func not in functions:
            return f"Error: Unknown function {func}"
        try:
            value = functions[func](evaluate(arg))
        except Exception:
            return "Error: Invalid function argument"
        expr = expr[:match.start()] + str(value) + expr[match.end():]

    # Only allow safe characters
    if not re.fullmatch(r'[\d\.\+\-\*/%\(\)** ]+', expr):
        return "Error: Invalid characters"

    try:
        return eval(expr, {"__builtins__": None}, {})
    except ZeroDivisionError:
        return "Error: Division by zero"
    except Exception:
        return "Error: Invalid expression"

while True:
    expr = input("Enter calculation or type 'mode' to switch angle mode: ").strip()
    if expr.lower() == 'exit':
        print("Exiting calculator.")
        break
    if expr.lower() == 'mode':
        angle_mode = "rad" if angle_mode=="deg" else "deg"
        # Update trig functions to new mode
        functions.update({
            'sin': lambda x: math.sin(math.radians(x)) if angle_mode=="deg" else math.sin(x),
            'cos': lambda x: math.cos(math.radians(x)) if angle_mode=="deg" else math.cos(x),
            'tan': lambda x: math.tan(math.radians(x)) if angle_mode=="deg" else math.tan(x),
            'asin': lambda x: math.degrees(math.asin(x)) if angle_mode=="deg" else math.asin(x),
            'acos': lambda x: math.degrees(math.acos(x)) if angle_mode=="deg" else math.acos(x),
            'atan': lambda x: math.degrees(math.atan(x)) if angle_mode=="deg" else math.atan(x)
        })
        print(f"Angle mode switched to {angle_mode}")
        continue
    result = evaluate(expr)
    print("Result:", result)
